{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Recipes</h2>
  <div class="text-muted small">LLM placeholder generates ideas from your pantry.</div>
</div>
<div class="card mb-4">
  <div class="card-body">
    <form method="post" class="row gy-3">
      <div class="col-md-3">
        <label class="form-label">Keyword or ingredient</label>
        <input class="form-control" name="keyword" placeholder="chicken, pasta..." value="{{ keyword }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Servings</label>
        <input type="number" class="form-control" name="servings" value="{{ servings }}" min="1">
      </div>
      <div class="col-md-7">
        <label class="form-label">Preferences & filters</label>
        <div class="row g-2">
          <div class="col-md-4 form-check">
            <input class="form-check-input" type="checkbox" name="only_have" value="1" {% if options.only_have %}checked{% endif %}>
            <label class="form-check-label">Use only what I have</label>
          </div>
          <div class="col-md-4 form-check">
            <input class="form-check-input" type="checkbox" name="minimize_missing" value="1" {% if options.minimize_missing %}checked{% endif %}>
            <label class="form-check-label">Minimize missing</label>
          </div>
          <div class="col-md-4 form-check">
            <input class="form-check-input" type="checkbox" name="ignore_spices" value="1" {% if options.ignore_spices %}checked{% endif %}>
            <label class="form-check-label">Ignore spices missing</label>
          </div>
          <div class="col-md-3 form-check">
            <input class="form-check-input" type="checkbox" name="high_protein" value="1" {% if preferences.high_protein %}checked{% endif %}>
            <label class="form-check-label">High protein</label>
          </div>
          <div class="col-md-3 form-check">
            <input class="form-check-input" type="checkbox" name="low_carb" value="1" {% if preferences.low_carb %}checked{% endif %}>
            <label class="form-check-label">Low carb</label>
          </div>
        </div>
      </div>
      <div class="col-12">
        <label class="form-label">Tags</label>
        <div class="d-flex flex-wrap gap-2">
          {% set tag_list = ['gluten-free','dairy-free','vegan','vegetarian','spicy','quick-meal','budget','high-protein','low-carb','kid-friendly'] %}
          {% for tag in tag_list %}
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="tags" value="{{ tag }}" {% if tag in preferences.tags %}checked{% endif %}>
            <label class="form-check-label">{{ tag }}</label>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="col-12">
        <button class="btn btn-primary">Find recipes</button>
      </div>
    </form>
  </div>
</div>
<div class="row g-3">
  <div class="col-lg-8">
    <h4 class="mb-3">Suggestions</h4>
    {% if results %}
      {% for entry in results %}
        {% set recipe = entry.recipe %}
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5>{{ recipe.name }}</h5>
                <div class="small text-muted">Servings: {{ recipe.servings }}</div>
              </div>
              <div class="d-flex flex-wrap gap-1">
                {% for tag in recipe.tags %}<span class="badge text-bg-secondary">{{ tag }}</span>{% endfor %}
              </div>
            </div>
            <p class="mt-2">{{ recipe.instructions }}</p>
            <h6>Ingredients</h6>
            <ul class="list-unstyled">
              {% for ing in recipe.ingredients %}
              <li>
                {{ ing.quantity|round(1) }} {{ ing.unit }} {{ ing.name }}
                {% if ing in entry.missing %}<span class="badge text-bg-danger">Missing</span>{% endif %}
              </li>
              {% endfor %}
            </ul>
            <div class="mt-3 d-flex gap-2">
              <form method="post" action="{{ url_for('save_recipe') }}">
                <input type="hidden" name="recipe" value='{{ recipe|tojson }}'>
                <button class="btn btn-outline-primary btn-sm" type="submit">Save</button>
              </form>
              <form method="post" action="{{ url_for('cook_recipe') }}">
                <input type="hidden" name="recipe" value='{{ recipe|tojson }}'>
                <input type="hidden" name="servings" value="{{ recipe.servings }}">
                <button class="btn btn-success btn-sm" type="submit">Cook</button>
              </form>
              {% if entry.missing %}
              <span class="text-danger small">Missing: {{ entry.missing|map(attribute='name')|list|join(', ') }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">Run a search to see recipe ideas tailored to your pantry.</p>
    {% endif %}
  </div>
  <div class="col-lg-4">
    <h4>Saved recipes</h4>
    <div class="list-group mb-4">
      {% for s in saved %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>{{ s.name }}</strong>
            <div class="small text-muted">Servings: {{ s.servings }}</div>
          </div>
          <form method="post" action="{{ url_for('cook_recipe') }}">
            <input type="hidden" name="recipe" value='{{ {'name':s.name,'ingredients':s.ingredient_list(),'instructions':s.instructions,'tags':s.tag_list(),'servings':s.servings}|tojson }}'>
            <button class="btn btn-sm btn-success">Cook</button>
          </form>
        </div>
      </div>
      {% else %}
      <div class="list-group-item text-muted">No saved recipes yet.</div>
      {% endfor %}
    </div>
    <h4>Cooked history</h4>
    <ul class="list-group">
      {% for c in cooked %}
      <li class="list-group-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>{{ c.name }}</strong>
            <div class="small text-muted">{{ c.cooked_at.strftime('%Y-%m-%d %H:%M') if c.cooked_at else '' }} | Rating: {{ c.rating if c.rating is not none else 'n/a' }}</div>
          </div>
          <form method="post" action="{{ url_for('rate_recipe', recipe_id=c.id) }}" class="d-flex align-items-center gap-1">
            <input type="number" name="rating" min="0" max="10" value="{{ c.rating or 0 }}" class="form-control form-control-sm" style="width:80px">
            <button class="btn btn-outline-primary btn-sm">Rate</button>
          </form>
        </div>
      </li>
      {% else %}
      <li class="list-group-item text-muted">Cook something to see it here.</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}
